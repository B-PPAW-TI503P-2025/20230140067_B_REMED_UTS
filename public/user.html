<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - Library System</title>
  <style>
    :root {
      --primary: #6366f1;
      --secondary: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --bg: #f3f4f6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #1e293b; }

    /* Navbar */
    .navbar {
      background: white; padding: 1rem 2rem; display: flex;
      justify-content: space-between; align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100;
    }

    .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }

    /* Card & Welcome */
    .welcome-card { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; }
    .card { background: white; border-radius: 16px; padding: 1.5rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

    h2 { font-size: 1.1rem; color: var(--secondary); text-transform: uppercase; margin-bottom: 1.5rem; letter-spacing: 0.05em; }

    /* Table */
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; border-bottom: 2px solid #f3f4f6; color: var(--secondary); font-size: 0.85rem; }
    td { padding: 16px 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; }
    tr:hover { background-color: #f9fafb; }

    /* Badges & Buttons */
    .stock-badge { background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
    .btn-pinjam { background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-pinjam:hover { background: #059669; transform: translateY(-1px); }
    .btn-pinjam:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-logout { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; }
    .btn-logout:hover { background: rgba(255,255,255,0.3); }

    /* Status Messages */
    #msg { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; font-size: 0.9rem; font-weight: 500; }
    .msg-ok { background: #dcfce7; color: #166534; display: block !important; }
    .msg-error { background: #fee2e2; color: #991b1b; display: block !important; }

    .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
  </style>
</head>
<body>

  <nav class="navbar">
    <h1 style="font-size: 1.25rem; font-weight: 800; color: var(--primary);">E-Library</h1>
    <div id="status-location" style="font-size: 0.75rem; color: var(--secondary);">üìç GPS Ready</div>
  </nav>

  <div class="container">
    <div class="welcome-card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2 style="color: white; margin-bottom: 0.2rem; text-transform: none;">Selamat Datang!</h2>
          <p id="who" style="opacity: 0.9; font-size: 0.9rem;"></p>
        </div>
        <button id="btnLogout" class="btn-logout">Keluar</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2>Katalog Buku Tersedia</h2>
        <button onclick="loadBooks()" style="background:none; border:none; color:var(--primary); cursor:pointer; font-size:0.85rem; font-weight:600;">üîÑ Refresh</button>
      </div>

      <div id="msg"></div>

      <table>
        <thead>
          <tr>
            <th>Judul & Penulis</th>
            <th style="text-align: center;">Tersedia</th>
            <th style="text-align: right;">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = "http://localhost:3000";

    function requireUser() {
      const role = localStorage.getItem("role");
      const userId = localStorage.getItem("userId");
      if (role !== "user" || !userId) {
        window.location.href = "/login.html";
      }
      document.getElementById("who").textContent = `ID Pengguna: ${userId}`;
    }

    function userHeaders() {
      return {
        "Content-Type": "application/json",
        "x-user-role": "user",
        "x-user-id": localStorage.getItem("userId"),
      };
    }

    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/login.html";
    });

    async function loadBooks() {
      try {
        const res = await fetch(`${API}/api/books`);
        const books = await res.json();
        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        books.forEach(b => {
          const isOutOfStock = b.stock <= 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <div style="font-weight:600; color:#111827">${b.title}</div>
              <div style="font-size:0.8rem; color:var(--secondary)">${b.author}</div>
            </td>
            <td style="text-align: center;">
              <span class="stock-badge" style="${isOutOfStock ? 'background:#fee2e2; color:#b91c1c' : ''}">
                ${b.stock} eks
              </span>
            </td>
            <td style="text-align: right;">
              <button class="btn-pinjam" 
                      ${isOutOfStock ? 'disabled' : ''} 
                      onclick="handleBorrow(this, ${b.id}, '${b.title}')">
                ${isOutOfStock ? 'Habis' : 'Pinjam'}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        showMsg("Gagal memuat buku. Periksa koneksi server.", true);
      }
    }

    function showMsg(text, isError = false) {
      const msgDiv = document.getElementById("msg");
      msgDiv.textContent = text;
      msgDiv.className = isError ? "msg-error" : "msg-ok";
      setTimeout(() => { msgDiv.className = ""; }, 5000);
    }

    async function handleBorrow(btn, bookId, title) {
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = `<span class="loading-dots">Proses</span>`;

      // 1. Ambil Lokasi (Geolocation)
      let coords = { lat: null, lon: null };
      
      const getPos = () => new Promise((resolve) => {
        if (!navigator.geolocation) return resolve();
        navigator.geolocation.getCurrentPosition(
          (p) => resolve({ lat: p.coords.latitude, lon: p.coords.longitude }),
          () => resolve(),
          { timeout: 5000 }
        );
      });

      const pos = await getPos();
      if (pos) coords = pos;

      // 2. Kirim ke API
      try {
        const res = await fetch(`${API}/api/borrow`, {
          method: "POST",
          headers: userHeaders(),
          body: JSON.stringify({
            bookId: bookId,
            latitude: coords.lat,
            longitude: coords.lon
          })
        });

        const data = await res.json();

        if (res.ok) {
          showMsg(`Berhasil meminjam buku "${title}"!`);
          await loadBooks();
        } else {
          showMsg(data.message || "Gagal meminjam buku", true);
          btn.disabled = false;
          btn.textContent = originalText;
        }
      } catch (e) {
        showMsg("Terjadi kesalahan sistem.", true);
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    requireUser();
    loadBooks();
  </script>
</body>
</html>